---
# Brew.
- name: Ensure dnsmasq is installed.
  homebrew:
    name: dnsmasq
    state: present

- name: Ensure configure directory
  sudo: yes
  file:
    dest: /usr/local/etc/dnsmasq.d
    state: directory

- name: Ensure dnsmasq configuration
  sudo: yes
  become: yes
  blockinfile:
    dest: "/usr/local/etc/dnsmasq.conf"
    marker: "# {mark} ANSIBLE MANAGED BLOCK dev_tld {{ item.tld|default(item) }}"
    block: |
     address=/.{{ item.tld|default(item) }}/{{ item.ip|default("127.0.0.1") }}
    state: present
  with_items: "{{ dnsmasq_resolver|default(omit) }}"

# - name: "Ensure brew services is available'"
#   shell: "brew services"

- name: "Restart dnsmasq"
  shell: "brew services restart dnsmasq"

- name: Ensure /etc/resolver directory exists.
  sudo: yes
  become: yes
  file:
    path: /etc/resolver
    state: directory

- name: "Add resolver for TLD '{{ item.tld|default(item) }}'"
  sudo: yes
  become: yes
  lineinfile:
    dest: "/etc/resolver/{{ item.tld|default(item) }}"
    line: "nameserver 127.0.0.1"
    create: true
    state: present
  with_items: "{{ dnsmasq_resolver|default(omit) }}"